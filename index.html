<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Battle Arena</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .slot-machine-text {
            font-family: 'Courier New', Courier, monospace;
            background: #1e293b;
            border: 1px solid #334155;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.5);
        }
        .neon-btn {
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        .neon-btn:hover {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.8);
            transform: translateY(-2px);
        }
        .card-bg {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- DONNÉES INITIALES ---
    const INITIAL_DATA = {
        characters: [
            { id: 1, fr: "Chevalier Cyberpunk", en: "Cyberpunk Knight", img: null },
            { id: 2, fr: "Sorcier maladroit", en: "Clumsy Wizard", img: null },
            { id: 3, fr: "Chat astronaute", en: "Astronaut Cat", img: null }
        ],
        locations: [
            { id: 1, fr: "Laboratoire secret", en: "Secret Laboratory", img: null },
            { id: 2, fr: "Forêt de cristal", en: "Crystal Forest", img: null },
            { id: 3, fr: "Tokyo néon sous la pluie", en: "Neon Tokyo Rain", img: null }
        ],
        objects: [
            { id: 1, fr: "Sabre laser en bois", en: "Wooden Lightsaber", img: null },
            { id: 2, fr: "Banane radioactive", en: "Radioactive Banana", img: null },
            { id: 3, fr: "Livre volant", en: "Flying Book", img: null }
        ],
        constraints: [
            { id: 1, fr: "Style : Pixel Art", en: "Style: Pixel Art", type: "style" },
            { id: 2, fr: "Noir et Blanc", en: "Black & White", type: "rule" },
            { id: 3, fr: "Vue isométrique", en: "Isometric View", type: "rule" }
        ],
        imposed: {
            active: false,
            description: "Intégrer cette image spécifique",
            img: null
        }
    };

    const TRANSLATIONS = {
        fr: {
            title: "BATAILLE DE PROMPTS",
            launch: "LANCER LE DÉFI",
            timer: "TEMPS RESTANT",
            character: "PERSONNAGE",
            location: "LIEU / DÉCOR",
            object: "OBJET",
            constraint: "CONTRAINTE",
            settings: "Paramètres",
            history: "Historique",
            imposed: "Figure Imposée",
            imposed_desc: "Vous devez inclure ceci :",
            add_item: "Ajouter",
            delete: "Supprimer",
            upload: "Image",
            minutes: "minutes",
            seconds: "secondes",
            restore: "Restaurer ce tirage",
            clear_hist: "Effacer l'historique",
            mode_admin: "Mode Admin",
            back: "Retour"
        },
        en: {
            title: "PROMPT BATTLE",
            launch: "START BATTLE",
            timer: "TIME REMAINING",
            character: "CHARACTER",
            location: "LOCATION",
            object: "OBJECT",
            constraint: "CONSTRAINT",
            settings: "Settings",
            history: "History",
            imposed: "Imposed Figure",
            imposed_desc: "You must include this:",
            add_item: "Add",
            delete: "Delete",
            upload: "Image",
            minutes: "minutes",
            seconds: "seconds",
            restore: "Restore this draw",
            clear_hist: "Clear History",
            mode_admin: "Admin Mode",
            back: "Back"
        }
    };

    // --- COMPOSANT PRINCIPAL ---
    function App() {
        // State
        const [lang, setLang] = useState('fr');
        const [view, setView] = useState('home'); // home, admin, history
        const [data, setData] = useState(INITIAL_DATA);
        
        // Selection State
        const [selection, setSelection] = useState({ char: null, loc: null, obj: null, constr: null });
        const [isSpinning, setIsSpinning] = useState(false);
        const [showConstraint, setShowConstraint] = useState(false);
        
        // Timer State
        const [timerDuration, setTimerDuration] = useState(5); // minutes
        const [timeLeft, setTimeLeft] = useState(null);
        const [timerActive, setTimerActive] = useState(false);

        // History
        const [history, setHistory] = useState([]);

        // Load from LocalStorage on mount
        useEffect(() => {
            const savedData = localStorage.getItem('promptBattleData');
            const savedHistory = localStorage.getItem('promptBattleHistory');
            if (savedData) setData(JSON.parse(savedData));
            if (savedHistory) setHistory(JSON.parse(savedHistory));
        }, []);

        // Save to LocalStorage on change
        useEffect(() => {
            localStorage.setItem('promptBattleData', JSON.stringify(data));
        }, [data]);

        useEffect(() => {
            localStorage.setItem('promptBattleHistory', JSON.stringify(history));
        }, [history]);

        // Timer Logic
        useEffect(() => {
            let interval = null;
            if (timerActive && timeLeft > 0) {
                interval = setInterval(() => {
                    setTimeLeft(timeLeft - 1);
                }, 1000);
            } else if (timeLeft === 0) {
                setTimerActive(false);
                // Play sound or alert here
            }
            return () => clearInterval(interval);
        }, [timerActive, timeLeft]);

        const t = TRANSLATIONS[lang];

        // --- LOGIC : SLOT MACHINE ---
        const handleSpin = () => {
            if (isSpinning) return;
            setIsSpinning(true);
            
            // Animation duration
            let duration = 2000; 
            let steps = 20;
            let stepCount = 0;

            const interval = setInterval(() => {
                // Random flicker during spin
                setSelection({
                    char: data.characters[Math.floor(Math.random() * data.characters.length)],
                    loc: data.locations[Math.floor(Math.random() * data.locations.length)],
                    obj: data.objects[Math.floor(Math.random() * data.objects.length)],
                    constr: showConstraint ? data.constraints[Math.floor(Math.random() * data.constraints.length)] : null
                });
                stepCount++;
                if (stepCount >= steps) {
                    clearInterval(interval);
                    finalizeSpin();
                }
            }, duration / steps);
        };

        const finalizeSpin = () => {
            const finalSel = {
                char: data.characters[Math.floor(Math.random() * data.characters.length)],
                loc: data.locations[Math.floor(Math.random() * data.locations.length)],
                obj: data.objects[Math.floor(Math.random() * data.objects.length)],
                constr: showConstraint ? data.constraints[Math.floor(Math.random() * data.constraints.length)] : null
            };
            
            setSelection(finalSel);
            setIsSpinning(false);
            
            // Add to History
            const newHistoryItem = {
                timestamp: new Date().toISOString(),
                selection: finalSel,
                imposed: data.imposed.active ? data.imposed : null
            };
            setHistory([newHistoryItem, ...history]);

            // Start Timer
            setTimeLeft(timerDuration * 60);
            setTimerActive(true);
        };

        const restoreFromHistory = (item) => {
            setSelection(item.selection);
            setView('home');
        };

        // --- UI COMPONENTS ---

        const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        // File Upload Helper
        const handleImageUpload = (e, category, id) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onloadend = () => {
                const newData = {...data};
                if (category === 'imposed') {
                    newData.imposed.img = reader.result;
                } else {
                    const list = newData[category];
                    const itemIndex = list.findIndex(i => i.id === id);
                    if (itemIndex > -1) list[itemIndex].img = reader.result;
                }
                setData(newData);
            };
            if (file) reader.readAsDataURL(file);
        };

        const handleAddData = (category, fr, en) => {
            const newData = {...data};
            newData[category].push({
                id: Date.now(),
                fr: fr,
                en: en,
                img: null,
                type: category === 'constraints' ? 'rule' : null
            });
            setData(newData);
        };

        const handleDeleteData = (category, id) => {
             const newData = {...data};
             newData[category] = newData[category].filter(i => i.id !== id);
             setData(newData);
        };

        // --- VUES ---

        const AdminPanel = () => {
            const [newItem, setNewItem] = useState({fr: '', en: ''});
            const [activeTab, setActiveTab] = useState('characters');

            return (
                <div className="p-6 max-w-4xl mx-auto card-bg rounded-xl mt-10">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-blue-400">{t.mode_admin}</h2>
                        <button onClick={() => setView('home')} className="text-sm bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">{t.back}</button>
                    </div>

                    {/* Timer Settings */}
                    <div className="mb-8 p-4 border border-gray-700 rounded">
                        <label className="block mb-2 font-bold">Timer (minutes)</label>
                        <input type="number" value={timerDuration} onChange={(e) => setTimerDuration(parseInt(e.target.value))} className="bg-gray-800 p-2 rounded text-white w-20" />
                    </div>

                    {/* Imposed Figure */}
                    <div className="mb-8 p-4 border border-gray-700 rounded">
                         <div className="flex items-center gap-4 mb-4">
                            <input type="checkbox" checked={data.imposed.active} onChange={(e) => setData({...data, imposed: {...data.imposed, active: e.target.checked}})} className="w-5 h-5" />
                            <span className="font-bold text-lg">{t.imposed}</span>
                         </div>
                         {data.imposed.active && (
                             <div className="flex gap-4 items-center">
                                <input type="text" value={data.imposed.description} onChange={(e) => setData({...data, imposed: {...data.imposed, description: e.target.value}})} className="bg-gray-800 p-2 rounded w-full" />
                                <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, 'imposed')} className="text-sm text-gray-400" />
                                {data.imposed.img && <img src={data.imposed.img} className="h-10 w-10 object-cover rounded" />}
                             </div>
                         )}
                    </div>

                    {/* CRUD Tabs */}
                    <div className="flex gap-2 mb-4">
                        {['characters', 'locations', 'objects', 'constraints'].map(cat => (
                            <button key={cat} onClick={() => setActiveTab(cat)} className={`px-4 py-2 rounded ${activeTab === cat ? 'bg-blue-600' : 'bg-gray-700'}`}>
                                {cat.charAt(0).toUpperCase() + cat.slice(1)}
                            </button>
                        ))}
                    </div>

                    {/* Add New */}
                    <div className="flex gap-2 mb-4">
                        <input placeholder="Nom FR" value={newItem.fr} onChange={e => setNewItem({...newItem, fr: e.target.value})} className="bg-gray-800 p-2 rounded flex-1" />
                        <input placeholder="Name EN" value={newItem.en} onChange={e => setNewItem({...newItem, en: e.target.value})} className="bg-gray-800 p-2 rounded flex-1" />
                        <button onClick={() => { handleAddData(activeTab, newItem.fr, newItem.en); setNewItem({fr:'', en:''}) }} className="bg-green-600 hover:bg-green-500 px-4 rounded">+</button>
                    </div>

                    {/* List */}
                    <div className="max-h-60 overflow-y-auto">
                        {data[activeTab].map(item => (
                            <div key={item.id} className="flex justify-between items-center bg-gray-800 p-2 mb-2 rounded">
                                <div>
                                    <div className="font-bold text-sm">{item.fr}</div>
                                    <div className="text-xs text-gray-400">{item.en}</div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <label className="cursor-pointer text-xs bg-gray-700 px-2 py-1 rounded hover:bg-gray-600">
                                        IMG
                                        <input type="file" accept="image/*" className="hidden" onChange={(e) => handleImageUpload(e, activeTab, item.id)} />
                                    </label>
                                    {item.img && <span className="text-green-400 text-xs">✓</span>}
                                    <button onClick={() => handleDeleteData(activeTab, item.id)} className="text-red-400 hover:text-red-300 px-2">X</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const HistoryPanel = () => (
            <div className="p-6 max-w-4xl mx-auto card-bg rounded-xl mt-10">
                 <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-purple-400">{t.history}</h2>
                        <div>
                            <button onClick={() => setHistory([])} className="text-sm text-red-400 mr-4 hover:underline">{t.clear_hist}</button>
                            <button onClick={() => setView('home')} className="text-sm bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">{t.back}</button>
                        </div>
                </div>
                <div className="space-y-4">
                    {history.map((h, idx) => (
                        <div key={idx} className="bg-gray-800 p-4 rounded border border-gray-700 flex justify-between items-center">
                            <div className="text-sm">
                                <span className="text-gray-500 block mb-1">{new Date(h.timestamp).toLocaleTimeString()}</span>
                                <span className="text-blue-300">{h.selection.char[lang]}</span> + 
                                <span className="text-green-300"> {h.selection.loc[lang]}</span> + 
                                <span className="text-yellow-300"> {h.selection.obj[lang]}</span>
                                {h.selection.constr && <span className="text-pink-300 block">⚠️ {h.selection.constr[lang]}</span>}
                            </div>
                            <button onClick={() => restoreFromHistory(h)} className="text-xs bg-blue-900 text-blue-200 px-3 py-1 rounded hover:bg-blue-800">{t.restore}</button>
                        </div>
                    ))}
                    {history.length === 0 && <div className="text-center text-gray-500">Aucun historique.</div>}
                </div>
            </div>
        );

        const SlotCard = ({ title, item, colorClass }) => (
            <div className="flex-1 min-w-[200px]">
                <h3 className={`text-xs uppercase tracking-widest font-bold mb-2 ${colorClass}`}>{title}</h3>
                <div className="slot-machine-text p-4 rounded-lg h-32 flex flex-col justify-center items-center text-center relative overflow-hidden group">
                    {item ? (
                        <>
                            <div className="text-lg md:text-xl font-bold z-10 relative">{item[lang]}</div>
                            <div className="text-xs text-gray-500 mt-1 z-10 relative">{lang === 'fr' ? item.en : item.fr}</div>
                            {item.img && (
                                <div className="absolute inset-0 opacity-20 group-hover:opacity-40 transition-opacity">
                                    <img src={item.img} className="w-full h-full object-cover" />
                                </div>
                            )}
                        </>
                    ) : (
                        <span className="text-gray-600 text-4xl">?</span>
                    )}
                </div>
            </div>
        );

        const MainView = () => (
            <div className="max-w-6xl mx-auto p-4">
                {/* Header */}
                <header className="flex justify-between items-center mb-10 py-4">
                    <div className="flex items-center gap-2">
                        <i className="ph ph-robot text-3xl text-blue-500"></i>
                        <h1 className="text-2xl font-bold tracking-tighter">{t.title}</h1>
                    </div>
                    <div className="flex gap-2">
                        <button onClick={() => setLang(lang === 'fr' ? 'en' : 'fr')} className="px-3 py-1 rounded border border-gray-600 text-xs font-bold hover:bg-gray-800">
                            {lang.toUpperCase()}
                        </button>
                        <button onClick={() => setView('history')} className="p-2 text-gray-400 hover:text-white" title={t.history}>
                            <i className="ph ph-clock-counter-clockwise text-xl"></i>
                        </button>
                        <button onClick={() => setView('admin')} className="p-2 text-gray-400 hover:text-white" title={t.settings}>
                            <i className="ph ph-gear text-xl"></i>
                        </button>
                    </div>
                </header>

                {/* Timer Display */}
                <div className="text-center mb-8">
                    <div className={`text-6xl md:text-8xl font-mono font-bold tabular-nums ${timerActive ? 'text-red-500 animate-pulse' : 'text-gray-600'}`}>
                        {timeLeft !== null ? formatTime(timeLeft) : formatTime(timerDuration * 60)}
                    </div>
                    <div className="text-xs text-gray-500 uppercase tracking-widest mt-2">{t.timer}</div>
                </div>

                {/* Imposed Figure Alert */}
                {data.imposed.active && (
                    <div className="mb-8 bg-red-900/30 border border-red-500/50 p-4 rounded-lg flex items-center gap-4">
                        <div className="bg-red-500 text-white p-2 rounded-full"><i className="ph ph-warning"></i></div>
                        <div className="flex-1">
                            <h4 className="font-bold text-red-400 uppercase text-xs">{t.imposed}</h4>
                            <p>{data.imposed.description}</p>
                        </div>
                        {data.imposed.img && <img src={data.imposed.img} className="w-16 h-16 object-cover rounded border border-red-500/50" />}
                    </div>
                )}

                {/* Slots Area */}
                <div className="flex flex-col md:flex-row gap-4 mb-10">
                    <SlotCard title={t.character} item={selection.char} colorClass="text-blue-400" />
                    <SlotCard title={t.location} item={selection.loc} colorClass="text-green-400" />
                    <SlotCard title={t.object} item={selection.obj} colorClass="text-yellow-400" />
                    {showConstraint && (
                        <SlotCard title={t.constraint} item={selection.constr} colorClass="text-pink-400" />
                    )}
                </div>

                {/* Controls */}
                <div className="flex flex-col items-center gap-6">
                    <div className="flex items-center gap-2 cursor-pointer" onClick={() => setShowConstraint(!showConstraint)}>
                        <div className={`w-10 h-6 rounded-full p-1 duration-300 ${showConstraint ? 'bg-pink-600' : 'bg-gray-700'}`}>
                            <div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-300 ${showConstraint ? 'translate-x-4' : ''}`}></div>
                        </div>
                        <span className={`text-sm font-bold ${showConstraint ? 'text-white' : 'text-gray-500'}`}>
                            {showConstraint ? '+ ' + t.constraint : t.constraint}
                        </span>
                    </div>

                    <button 
                        onClick={handleSpin} 
                        disabled={isSpinning}
                        className="neon-btn bg-blue-600 hover:bg-blue-500 text-white text-xl font-bold py-4 px-12 rounded-full flex items-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <i className={`ph ph-shuffle ${isSpinning ? 'animate-spin' : ''}`}></i>
                        {isSpinning ? '...' : t.launch}
                    </button>
                </div>

            </div>
        );

        return (
            <div className="min-h-screen pb-20">
                {view === 'home' && <MainView />}
                {view === 'admin' && <AdminPanel />}
                {view === 'history' && <HistoryPanel />}
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>

</body>
</html>
